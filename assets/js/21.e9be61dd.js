(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{597:function(t,a,s){"use strict";s.r(a);var n=s(7),r=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"_8用户认证"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8用户认证"}},[t._v("#")]),t._v(" 8用户认证")]),t._v(" "),s("h2",{attrs:{id:"_8-1-前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-前言"}},[t._v("#")]),t._v(" 8.1 前言")]),t._v(" "),s("blockquote",[s("p",[t._v("项目地址：https://gitee.com/guangmujun/micro-blog 个人网站：https://guangmujun.cn\nFlask Web学习：https://guangmujun.cn/archives/category/learning-note/flask-web\nMySQL学习：https://guangmujun.cn/archives/category/learning-note/mysql-note 参考：")]),t._v(" "),s("ul",[s("li",[t._v("https://www.cnblogs.com/yeer-xuan/p/13488291.html")]),t._v(" "),s("li",[t._v("https://stackoverflow.com/questions/61356834/wtforms-install-email-\nvalidator-for-email-validation-support")])])]),t._v(" "),s("h2",{attrs:{id:"_8-2-flask的认证扩展"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-flask的认证扩展"}},[t._v("#")]),t._v(" 8.2 Flask的认证扩展")]),t._v(" "),s("ul",[s("li",[t._v("Flask-Login：管理已登录用户的用户会话")]),t._v(" "),s("li",[t._v("Werkzeug：计算密码散列值并进行核对")]),t._v(" "),s("li",[t._v("itsdangerous：生成并核对加密安全令牌")])]),t._v(" "),s("h2",{attrs:{id:"_8-3-密码安全性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-密码安全性"}},[t._v("#")]),t._v(" 8.3 密码安全性")]),t._v(" "),s("p",[t._v("存储密码的散列值 【密码】与【密码散列值】是一对多的关系 "),s("strong",[t._v("@property")]),t._v(" python中的@property装饰器可以总结为两个作用：")]),t._v(" "),s("ol",[s("li",[t._v("让函数可以像普通变量一样使用")]),t._v(" "),s("li",[t._v("对要读取的数据进行预处理")])]),t._v(" "),s("p",[t._v("*"),s("em",[t._v("@ "),s("em",[t._v(".setter")])]),t._v(" python中的@*.setter装饰器可以总结为两个作用：")]),t._v(" "),s("ol",[s("li",[t._v("对要存入的数据进行预处理")]),t._v(" "),s("li",[t._v("设置可读属性(不可修改)")])]),t._v(" "),s("p",[s("strong",[t._v("注意")]),t._v(" ：@ "),s("em",[t._v(".setter装饰器必须在@property装饰器的后面，且两个被修饰的函数的名称必须保持一致，")]),t._v(" 即为函数名称。\n"),s("code",[t._v("app/models.py")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    from werkzeug.security import generate_password_hash, check_password_hash\n​"),s("br"),t._v("\nclass User(db.Model):\n"),s("strong",[t._v("tablename")]),t._v(" = 'users'\nid = db.Column(db.Integer, primary_key=True)\nusername = db.Column(db.String(64), unique=True, index=True)\nrole_id = db.Column(db.Integer, db.ForeignKey('roles.id'))\npassword_hash = db.Column(db.String(128))")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("    @property  # 修饰方法，让方法可以像属性一样被访问\n    def password(self):  # 试图读取原来的密码时，密码的散列值不可读\n        raise AttributeError('密码不可读！')\n\n    @password.setter  # 使password属性在存入前进行预处理\n    def password(self, password):\n        self.password_hash = generate_password_hash(password)\n\n    def verify_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\n    def __repr__(self):\n        return '<User %r>' % self.username\n")])])]),s("h2",{attrs:{id:"_8-4-创建认证蓝本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-4-创建认证蓝本"}},[t._v("#")]),t._v(" 8.4 创建认证蓝本")]),t._v(" "),s("p",[t._v("不同的程序功能，使用不同的蓝本，这里定义auth蓝本 "),s("code",[t._v("app/auth/__init__.py")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    from flask import Blueprint\n​"),s("br"),t._v("\nauth = Blueprint('auth', "),s("strong",[t._v("name")]),t._v(")")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("from . import view\n")])])]),s("p",[t._v("​")]),t._v(" "),s("p",[s("code",[t._v("app/auth/views.py")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    from flask import render_template\n​    from . import auth\n​"),s("br"),t._v("\n@auth.route('/login')\ndef login():\nreturn render_template('auth/login.html')")]),t._v(" "),s("p",[t._v("使用蓝本的route修饰器定义与认证相关的路由 ![](https://my-imags.oss-cn-\nshanghai.aliyuncs.com/pic/20210317110403.png) "),s("code",[t._v("app/__init__.py")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    from .auth import auth as auth_blueprint\n​    app.register_blueprint(auth_blueprint, url_prefix='/auth')  # 使用url_prefix参数，蓝本中定义的所有路由都会加上指定的前缀")]),t._v(" "),s("p",[t._v("login路由对应的URI为"),s("code",[t._v("localhost:5000/auth/login")])]),t._v(" "),s("h2",{attrs:{id:"_8-5-使用flask-login认证用户"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-使用flask-login认证用户"}},[t._v("#")]),t._v(" 8.5 使用Flask-Login认证用户")]),t._v(" "),s("p",[t._v("Flask-Login：管理用户认证系统中的认证状态，且不依赖特定的认证机制 安装：")]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    conda install flask-login")]),t._v(" "),s("h3",{attrs:{id:"_8-5-1-准备用于登录的用户模型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-1-准备用于登录的用户模型"}},[t._v("#")]),t._v(" 8.5.1 准备用于登录的用户模型")]),t._v(" "),s("p",[t._v("Flask-Login要求实现的用户方法：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("is_authenticated")]),t._v("：用户是否已经登录")]),t._v(" "),s("li",[s("code",[t._v("is_activate")]),t._v("：是否允许用户登录")]),t._v(" "),s("li",[s("code",[t._v("is_anonymous")]),t._v("：是否是匿名用户")]),t._v(" "),s("li",[s("code",[t._v("get_id()")]),t._v("：分会用户的唯一标志符")])]),t._v(" "),s("p",[t._v("Flask-Login提供了一个UserMixin类，包含上述方法的默认实现，故将User模型进行修改： "),s("code",[t._v("app/models.py")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    from flask_login import UserMixin\n​"),s("br"),t._v("\nclass User(UserMixin, db.Model):\n"),s("strong",[t._v("tablename")]),t._v(" = 'users'\nid = db.Column(db.Integer, primary_key=True)\nemail = db.Column(db.String(64), unique=True, index=True)\nusername = db.Column(db.String(64), unique=True, index=True)\nrole_id = db.Column(db.Integer, db.ForeignKey('roles.id'))\npassword_hash = db.Column(db.String(128))")]),t._v(" "),s("p",[t._v("初始化Flask-Login "),s("code",[t._v("app/__init__.py")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    from flask_login import LoginManager\n​"),s("br"),t._v("\nlogin_manager = LoginManager()\nlogin_manager.session_protection = 'strong'      # 设置防止用户会话被篡改的安全等级\nlogin_manager.login_view = 'auth.login'          # 设置登录页面的端点")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v(" login_manager.init_app(app)\n")])])]),s("p",[t._v("实现Flask-Login要求的回调函数 "),s("code",[t._v("app/models.py")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    from . import login_manager\n​"),s("br"),t._v("\n@login_manager.user_loader  # 加载用户的回调函数\ndef load_user(user_id):\nreturn User.query.get(int(user_id))")]),t._v(" "),s("h3",{attrs:{id:"_8-5-2-保护路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-2-保护路由"}},[t._v("#")]),t._v(" 8.5.2 保护路由")]),t._v(" "),s("p",[t._v("保护路由只让认证用户访问 "),s("code",[t._v("app/auth/views.py")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    from flask_login import login_user, logout_user, login_required\n​"),s("br"),t._v("\n@auth.route('/logout')\n@login_required\ndef logout():\nlogout_user()\nflash('当前登录已经注销！')\nreturn redirect(url_for('main.index'))")]),t._v(" "),s("h3",{attrs:{id:"_8-5-3-添加登录表单"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-3-添加登录表单"}},[t._v("#")]),t._v(" 8.5.3 添加登录表单")]),t._v(" "),s("p",[s("code",[t._v("app/auth/forms.py")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    from flask_wtf import FlaskForm\n​    from wtforms import StringField, PasswordField, BooleanField, SubmitField\n​    from wtforms.validators import Length, Email, DataRequired\n​    import email_validator\n​"),s("br"),t._v("\nclass LoginForm(FlaskForm):\nemail = StringField('邮箱', validators=(DataRequired(), Length(1, 64), Email()))\npassword = PasswordField('密码', validators=[DataRequired()])\nremember_me = BooleanField('记住我')\nsubmit = SubmitField('登录')")]),t._v(" "),s("p",[t._v("定义登录页面使用的模块 "),s("code",[t._v("templates/auth/login.html")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v('{% extends "base.html" %}\n{% import "bootstrap/wtf.html" as wtf %}\n{% block title %}Flasky - Login{% endblock%}\n\n{% block page_content %}\n<div class="page-header">\n    <h1>登录</h1>\n</div>\n<div class="col-md-4">\n    '+t._s(t.wtf.quick_form(t.form))+"\n</div>\n{% endblock %}\n")])])]),s("p",[t._v("​")]),t._v(" "),s("p",[t._v("使用Flask-Bootstrap提供的"),s("code",[t._v("wtf.quick_form()")]),t._v("宏渲染表单即可 基模板中加入登录和注销的链接\n"),s("code",[t._v("app/templates/base.html")])]),t._v(" "),s("div",{staticClass:"language-html line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("ul")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("nav navbar-nav navbar-right"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        {% if current_user.is_authenticated %}\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("a")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("href")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("{{ url_for("),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("auth.logout"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v(") }}"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("注销"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("a")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        {% else %}\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("a")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("href")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("{{ url_for("),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("auth.login"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v(") }}"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("登录"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("a")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        {% endif %}\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("ul")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("用户登录时，显示注销，用户注销后，显示登录")]),t._v(" "),s("h3",{attrs:{id:"_8-5-4-登入用户"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-4-登入用户"}},[t._v("#")]),t._v(" 8.5.4 登入用户")]),t._v(" "),s("p",[s("code",[t._v("app/auth/views.py")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    from flask import render_template, redirect, request, url_for, flash\n​    from flask_login import login_user, logout_user, login_required\n​    from . import auth\n​    from ..models import User\n​    from .forms import LoginForm\n​"),s("br"),t._v("\n@auth.route('/login', methods=['GET', 'POST'])\ndef login():\nform = LoginForm()\nif form.validate_on_submit():\nuser = User.query.filter_by(email=form.email.data).first()\nif user is not None and user.verify_password(form.password.data):\nlogin_user(user, form.remember_me.data)\nreturn redirect(request.args.get('next') or url_for('main.index'))\nflash('无效的用户名或者密码')\nreturn render_template('auth/login.html', form=form)")]),t._v(" "),s("p",[s("code",[t._v("login_user()")]),t._v("有两个参数：\n第一个参数：要登录的用户，第二个参数：可选的“记住我”的布尔值，如果为True，会在用户浏览器中写入一个长期有效的cookies，使用这个cookies可以复现用户会话\n根据“Post/重定向/Get模式”，此处点击提交登录的Post请求后，也做了重定向")]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    redirect(request.args.get('next') or url_for('main.index'))")]),t._v(" "),s("p",[t._v("目标URL有两种可能：")]),t._v(" "),s("ul",[s("li",[t._v("重定向到首页")]),t._v(" "),s("li",[t._v("或是，用户访问未授权的URL时，会显示登录表单\n"),s("ul",[s("li",[t._v("Flask-Login把原地址保存在查询字符串的next参数中")]),t._v(" "),s("li",[t._v("这个参数可以从request.args字典中读取")]),t._v(" "),s("li",[t._v("读取到则显示登录表单，没有读取到则显示首页")])])])]),t._v(" "),s("h3",{attrs:{id:"_8-5-5-登出用户"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-5-登出用户"}},[t._v("#")]),t._v(" 8.5.5 登出用户")]),t._v(" "),s("p",[s("code",[t._v("app/auth/views.py")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    from flask_login import login_user, logout_user, login_required\n​"),s("br"),t._v("\n@auth.route('/logout')\n@login_required\ndef logout():\nlogout_user()\nflash('当前登录已经注销！')\nreturn redirect(url_for('main.index'))")]),t._v(" "),s("h3",{attrs:{id:"_8-5-6-测试登录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-6-测试登录"}},[t._v("#")]),t._v(" 8.5.6 测试登录")]),t._v(" "),s("p",[s("strong",[t._v("更新首页")]),t._v(" "),s("code",[t._v("templates/index.html")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v('       {% block page_content %}\n    <div class="page_content">\n        <div class="page-header">\n            <h1>你好, {% if current_user.is_authenticated %}'+t._s(t.current_user.username)+"{% else %}陌生人{% endif %}!</h1>\n    \n   {% if not known %}\n        <p> 很高兴遇见你！</p>\n        {% else %}\n        <p> 欢迎回来！ </p>\n        {% endif %}\n\n    </div>\n\n    "+t._s(t.wtf.quick_form(t.form))+'\n    <div class="page-bottom">\n        <p>日期：'+t._s(t.moment(t.current_time).format("LL"))+"</p>\n        <p>"+t._s(t.moment(t.current_time).fromNow(t.refresh=t.True))+" 来过</p>\n    </div>\n\n</div>\n{% endblock %}\n")])])]),s("p",[s("strong",[t._v("更新数据库")]),t._v(" ！！！ 由于数据库中模型已经变更，需要先对数据库进行迁移和更新")]),t._v(" "),s("ol",[s("li",[t._v("创建迁移脚本")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v('\n​    python hello.py db migrate -m "迁移信息"')]),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[t._v("更新数据库")])]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    python hello.py db upgrade")]),t._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[t._v("更新后的数据库效果 主要是users表的更新")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210317152755.png",alt:""}}),t._v(" "),s("strong",[t._v("在shell中注册新用户")]),t._v(" pycharm中设置运行参数为shell，运行")]),t._v(" "),s("p",[t._v("​"),s("br"),t._v("\n​    >>> u = User(email='john@163.com', username='john', password='cat')\n​    >>> db.session.add(u)\n​    >>> db.session.commit()")]),t._v(" "),s("p",[s("strong",[t._v("操作效果")])]),t._v(" "),s("ol",[s("li",[s("p",[t._v("直接打开 "),s("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210317153003.png",alt:""}})])]),t._v(" "),s("li",[s("p",[t._v("点击登录 "),s("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210317153031.png",alt:""}})])]),t._v(" "),s("li",[s("p",[t._v("输入在shell中注册的邮箱和密码，点击登录 "),s("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210317153115.png",alt:""}}),t._v(" "),s("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210317153129.png",alt:""}})])]),t._v(" "),s("li",[s("p",[t._v("点击注销")])])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210317153208.png",alt:""}})])])}),[],!1,null,null,null);a.default=r.exports}}]);