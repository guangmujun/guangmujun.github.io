(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{594:function(s,a,t){"use strict";t.r(a);var e=t(7),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"_5数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5数据库"}},[s._v("#")]),s._v(" 5数据库")]),s._v(" "),t("h2",{attrs:{id:"_5-1-前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-前言"}},[s._v("#")]),s._v(" 5.1 前言")]),s._v(" "),t("blockquote",[t("p",[s._v("项目地址：https://gitee.com/guangmujun/micro-blog 个人网站：https://guangmujun.cn\nMySQL学习：https://guangmujun.cn/archives/category/learning-note/mysql-note\n参考：https://stackoverflow.com/questions/53024891/modulenotfounderror-no-\nmodule-named-mysqldb")])]),s._v(" "),t("h2",{attrs:{id:"_5-2-数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-数据库"}},[s._v("#")]),s._v(" 5.2 数据库")]),s._v(" "),t("ul",[t("li",[s._v("关系型数据库（SQL数据库）")]),s._v(" "),t("li",[s._v("非关系型数据库（NoSQL数据库）")])]),s._v(" "),t("p",[t("strong",[s._v("SQL数据库")])]),s._v(" "),t("ul",[t("li",[s._v("行之间的联系称为关系")]),s._v(" "),t("li",[s._v("存储数据高效，但数据存放在多种表中较为复杂")])]),s._v(" "),t("p",[t("strong",[s._v("NoSQL数据库")])]),s._v(" "),t("ul",[t("li",[s._v("减少表的数量，增加了数据重复量")]),s._v(" "),t("li",[s._v("数据重复可以提升查询速度")])]),s._v(" "),t("p",[t("strong",[s._v("两种数据库的评价")])]),s._v(" "),t("ul",[t("li",[s._v("SQL数据库擅于用高效且紧凑的形式存储结构化数据")]),s._v(" "),t("li",[s._v("NoSQL放宽了一致性要求，获得性能上的优势")])]),s._v(" "),t("h2",{attrs:{id:"_5-3-python数据库框架"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-python数据库框架"}},[s._v("#")]),s._v(" 5.3 Python数据库框架")]),s._v(" "),t("p",[t("strong",[s._v("抽象层代码包")])]),s._v(" "),t("ul",[t("li",[s._v("直接处理高等级的Python对象，而不用处理数据库的实体")]),s._v(" "),t("li",[s._v("使用ORM或ODM将对象业务转换成数据库业务会有一定损耗，但微不足道")])]),s._v(" "),t("p",[t("strong",[s._v("抽象层")])]),s._v(" "),t("ul",[t("li",[s._v("对象关系映射（Object-Relational Mapper, ORM ）或对象文档映射（Object-Document Mapper, ODM）")]),s._v(" "),t("li",[s._v("把高层的面向对象操作转换成低层的数据库指令")])]),s._v(" "),t("h2",{attrs:{id:"_5-5-使用flask-sqlalchemy管理mysql"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-使用flask-sqlalchemy管理mysql"}},[s._v("#")]),s._v(" 5.5 使用Flask-SQLAlchemy管理MySQL")]),s._v(" "),t("p",[t("strong",[s._v("安装扩展")])]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\n​    conda install flask-sqlalchemy\n​    conda install pymysql")]),s._v(" "),t("p",[t("strong",[s._v("配置数据库")])]),s._v(" "),t("ul",[t("li",[t("code",[s._v("SQLALCHEMY_DATABASE_URI")]),s._v("设置数据库的URI")]),s._v(" "),t("li",[t("code",[s._v("SQLALCHEMY_COMMIT_ON_TEARDOWN")]),s._v("设置自动提交数据库中的变动")]),s._v(" "),t("li",[t("code",[s._v("SQLALCHEMY_TRACK_MODIFICATIONS")]),s._v("设置为Ture或False均可，不然会有warning")])]),s._v(" "),t("p",[s._v("hello.py")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\n​    from flask_sqlalchemy import SQLAlchemy\n​    import pymysql\n​    pymysql.install_as_MySQLdb()\n​"),t("br"),s._v("\n​    app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://{user}:{password}@{server}/{database}'.format(\n​                                    user='your-username', password='your-password', server='your-ip-port', database='your-database')\n​    app.config['SQLALCHEMY_COMMIT_ON_TEARDOWN'] = True\n​    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = True\n​"),t("br"),s._v("\ndb = SQLAlchemy(app)")]),s._v(" "),t("h2",{attrs:{id:"_5-5-定义模型和关系"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-定义模型和关系"}},[s._v("#")]),s._v(" 5.5 定义模型和关系")]),s._v(" "),t("p",[s._v("hello.py")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\n​    class Role(db.Model):\n​        "),t("strong",[s._v("tablename")]),s._v(" = 'roles'\n​        id = db.Column(db.Integer, primary_key=True)\n​        name = db.Column(db.String(64), unique=True)\n​        users = db.relationship('User', backref='role')\n​"),t("br"),s._v("\n​        def "),t("strong",[s._v("repr")]),s._v("(self):\n​            return '<Role %r>' % self.name")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\n​    class User(db.Model):\n​        "),t("strong",[s._v("tablename")]),s._v(" = 'users'\n​        id = db.Column(db.Integer, primary_key=True)\n​        username = db.Column(db.String(64), unique=True, index=True)\n​        role_id = db.Column(db.Integer, db.ForeignKey('roles.id'))\n​"),t("br"),s._v("\n​        def "),t("strong",[s._v("repr")]),s._v("(self):\n​            return '<User %r>' % self.username")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("__repr__")]),s._v("返回一个具有可读性的字符串表示模型，在调试和测试时使用")]),s._v(" "),t("li",[t("code",[s._v("index=True")]),s._v("为此列创建索引，提升查询效率")]),s._v(" "),t("li",[t("code",[s._v("Role")]),s._v("模型中的"),t("code",[s._v("users")]),s._v("返回与角色相关联的用户列表")]),s._v(" "),t("li",[t("code",[s._v("db.relationship()")]),s._v(" "),t("ul",[t("li",[s._v("第一个参数表示此关系另一端的模型名称")]),s._v(" "),t("li",[t("code",[s._v("backref")]),s._v("参数向"),t("code",[s._v("User")]),s._v("模型中添加一个"),t("code",[s._v("role")]),s._v("属性，这一属性可替代"),t("code",[s._v("role_id")]),s._v("访问"),t("code",[s._v("Role")]),s._v("模型")])])])]),s._v(" "),t("h2",{attrs:{id:"_5-6-数据库操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-数据库操作"}},[s._v("#")]),s._v(" 5.6 数据库操作")]),s._v(" "),t("h3",{attrs:{id:"_5-6-1-创建表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-1-创建表"}},[s._v("#")]),s._v(" 5.6.1 创建表")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\n​    python hello.py shell\n​    from hello import db\n​    db.create_all()")]),s._v(" "),t("p",[s._v("在shell中输入上述命令后，连接MySQL，效果如下： "),t("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210313114844.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"_5-6-2-插入行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-2-插入行"}},[s._v("#")]),s._v(" 5.6.2 插入行")]),s._v(" "),t("div",{staticClass:"language-python <blockquote> <blockquote> <blockquote> from hello import Role, User line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[s._v("admin_role "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Role"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Admin'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" mod_role "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Role"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Moderator'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" user_role "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\nRole"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'User'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" user_join "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" User"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("username"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'join'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" role"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("admin_role"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuser_susan "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" User"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("username"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'susan'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" role"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mod_role"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" user_tom "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\nUser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("username"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'tom'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" role"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("user_role"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("session"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("add_all"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("admin_role"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mod_role"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nuser_role"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" user_join"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" user_susan"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" user_tom"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("session"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("commit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210314193515.png",alt:""}}),s._v(" "),t("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210314193529.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"_5-6-3-修改行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-3-修改行"}},[s._v("#")]),s._v(" 5.6.3 修改行")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\n>>> mod_role.name = 'Mod'\n>>> db.session.add(mod_role)\n>>> db.session.commit()")]),s._v(" "),t("p",[s._v("​")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210314194102.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"_5-6-4-删除行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-4-删除行"}},[s._v("#")]),s._v(" 5.6.4 删除行")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\n>>> db.session.delete(admin_role)\n>>> db.session.commit()")]),s._v(" "),t("h3",{attrs:{id:"_5-6-3-查询行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-3-查询行"}},[s._v("#")]),s._v(" 5.6.3 查询行")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\n>>> Role.query.all()\n[<Role 'Admin'>, <Role 'Mod'>, <Role 'User'>]\n>>> User.query.filter_by(role=user_role).all()\n[<User 'tom'>]")]),s._v(" "),t("p",[s._v("​")]),s._v(" "),t("p",[t("strong",[s._v("过滤器：")]),s._v(" 参考：http://docs.sqlalchemy.org")]),s._v(" "),t("ul",[t("li",[s._v("filter()")]),s._v(" "),t("li",[s._v("filter_by()")]),s._v(" "),t("li",[s._v("limit()")]),s._v(" "),t("li",[s._v("offset()")]),s._v(" "),t("li",[s._v("order_by()")]),s._v(" "),t("li",[s._v("group_by()")])]),s._v(" "),t("p",[t("strong",[s._v("查询方法：")])]),s._v(" "),t("ul",[t("li",[s._v("all()")]),s._v(" "),t("li",[s._v("first()")]),s._v(" "),t("li",[s._v("first_or_404()")]),s._v(" "),t("li",[s._v("get()")]),s._v(" "),t("li",[s._v("get_or_404()")]),s._v(" "),t("li",[s._v("count()")]),s._v(" "),t("li",[s._v("paginate()")])]),s._v(" "),t("p",[t("strong",[s._v("自动执行查询：")])]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\nclass Role(db.Model):\nusers = db.relationship('User', backref='role', lazy='dynamic')")]),s._v(" "),t("p",[s._v("此处使用"),t("code",[s._v("lazy")]),s._v("参数后，"),t("code",[s._v("user_role.users")]),s._v("会返回一个尚未执行的查询，可将其修改为")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\nuser_role.users.order_by(User.username).all()")]),s._v(" "),t("h2",{attrs:{id:"_5-7-在视图函数中操作数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-7-在视图函数中操作数据库"}},[s._v("#")]),s._v(" 5.7 在视图函数中操作数据库")]),s._v(" "),t("p",[s._v("hello.py")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\n​"),t("br"),s._v("\n@app.route('/', methods=['GET', 'POST'])\ndef index():\nform = NameForm()\nif form.validate_on_submit():")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[s._v("        user = User.query.filter_by(username=form.name.data).first()\n        if user is None:\n            user = User(username=form.name.data)\n            db.session.add(user)\n            session['known'] = False\n        else:\n            session['known'] = True\n\n        old_name = session.get('name')\n        if old_name is not None and old_name != form.name.data:\n            flash(\"姓名已修改！\")\n        session['name'] = form.name.data\n        return redirect(url_for('index'))\n    return render_template('index.html', form=form, name=session.get('name'),known=session.get('known', False),\n                           current_time=datetime.utcnow())\n")])])]),t("p",[s._v("​")]),s._v(" "),t("p",[s._v("index.html")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v('\n{% extends "base.html" %}\n{% import "bootstrap/wtf.html" as wtf %}')]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[s._v('{% block title %}Flasky{% endblock %}\n\n{% block page_content %}\n<div class="page_content">\n    <div class="page-header">\n        <h1>你好, {% if name %}'+s._s(s.name)+"{% else %}陌生人{% endif %}!</h1>\n\n        {% if not known %}\n        <p> 很高兴遇见你！</p>\n        {% else %}\n        <p> 欢迎回来！ </p>\n        {% endif %}\n\n    </div>\n\n    "+s._s(s.wtf.quick_form(s.form))+'\n    <div class="page-bottom">\n        <p>日期：'+s._s(s.moment(s.current_time).format("LL"))+"</p>\n        <p>"+s._s(s.moment(s.current_time).fromNow(s.refresh=s.True))+" 来过</p>\n    </div>\n\n</div>\n{% endblock %}\n")])])]),t("p",[s._v("第一次打开首页效果 "),t("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210314200032.png",alt:""}}),s._v(" 输入框中输入“广慕君”，点击提交的效果\n"),t("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210314200126.png",alt:""}}),s._v(" "),t("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210314200153.png",alt:""}}),s._v("\n输入框中再次输入“广慕君”，点击提交后的效果 "),t("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210314200221.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"_5-8-集成python-shell"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-8-集成python-shell"}},[s._v("#")]),s._v(" 5.8 集成Python shell")]),s._v(" "),t("p",[s._v("让Flask-Script的shell命令自动导入特定的对象")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\nfrom flask_script import Shell")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\ndef make_shell_context():\nreturn dict(app=app, db=db, User=User, Role=Role)")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v('\nmanager.add_command("shell", Shell(make_context=make_shell_context))')]),s._v(" "),t("p",[s._v("效果")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\npython hello.py shell\n>>> app\n<Flask 'hello'>\n>>> User\n<class '"),t("strong",[s._v("main")]),s._v(".User'>")]),s._v(" "),t("h2",{attrs:{id:"_5-9-使用flask-migrate实现数据库迁移"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-9-使用flask-migrate实现数据库迁移"}},[s._v("#")]),s._v(" 5.9 使用Flask-MIgrate实现数据库迁移")]),s._v(" "),t("p",[t("strong",[s._v("需求：")]),s._v(" 修改数据库模型后，需要更新数据库，但使用Flask-\nSQLAlchemy时，需要先删除旧表，然后才能根据新的模型创建表，如此操作会丢失数据库中的所有数据。 更好的方法是用 "),t("strong",[s._v("数据库迁移框架")]),s._v("\n，类似于原码版本控制，可以跟踪数据库模型的变化，然后增量式的把变化应用到数据库中。")]),s._v(" "),t("h3",{attrs:{id:"_5-9-1-创建迁移仓库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-9-1-创建迁移仓库"}},[s._v("#")]),s._v(" 5.9.1 创建迁移仓库")]),s._v(" "),t("p",[s._v("安装：")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\nconda install flask-migrate")]),s._v(" "),t("p",[s._v("配置：")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\nfrom flask_migrate import Migrate, MigrateCommand")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[s._v("migrate = Migrate(app, db)\nmanager.add_command('db', MigrateCommand)\n")])])]),t("p",[s._v("创建迁移仓库")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\npython hello.py db inti")]),s._v(" "),t("h3",{attrs:{id:"_5-9-2-创建迁移脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-9-2-创建迁移脚本"}},[s._v("#")]),s._v(" 5.9.2 创建迁移脚本")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v('\npython hello.py db migrate -m "迁移信息"')]),s._v(" "),t("h3",{attrs:{id:"_5-9-3-更新数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-9-3-更新数据库"}},[s._v("#")]),s._v(" 5.9.3 更新数据库")]),s._v(" "),t("p",[s._v("​"),t("br"),s._v("\npython hello.py db upgrade")])])}),[],!1,null,null,null);a.default=n.exports}}]);