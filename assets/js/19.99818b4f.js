(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{595:function(a,n,s){"use strict";s.r(n);var t=s(7),e=Object(t.a)({},(function(){var a=this,n=a.$createElement,s=a._self._c||n;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"_6电子邮件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6电子邮件"}},[a._v("#")]),a._v(" 6电子邮件")]),a._v(" "),s("h2",{attrs:{id:"_6-1-前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-前言"}},[a._v("#")]),a._v(" 6.1 前言")]),a._v(" "),s("blockquote",[s("p",[a._v("项目地址：https://gitee.com/guangmujun/micro-blog 个人网站：https://guangmujun.cn\nFlask Web学习：https://guangmujun.cn/archives/category/learning-note/flask-web\nMySQL学习：https://guangmujun.cn/archives/category/learning-note/mysql-note\n参考：https://guangmujun.cn/archives/424")])]),a._v(" "),s("h2",{attrs:{id:"_6-2-使用flask-mail提供电子邮件支持"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-使用flask-mail提供电子邮件支持"}},[a._v("#")]),a._v(" 6.2 使用Flask-Mail提供电子邮件支持")]),a._v(" "),s("p",[s("strong",[a._v("安装：")])]),a._v(" "),s("p",[a._v("​"),s("br"),a._v("\n​    conda install flask-mail")]),a._v(" "),s("p",[s("strong",[a._v("配置：")]),a._v(" Flask-Mail连接到简单邮件传输协议（SMTP）服务器，并把邮件交给这个服务器发送。 hello.py配置Flask-\nMail使用Sina")]),a._v(" "),s("p",[a._v("​"),s("br"),a._v("\n​    app.config['MAIL_SERVER'] = 'smtp.sina.com'\n​    app.config['MAIL_PORT'] = 25\n​    app.config['MAIL_USERNAME'] = os.environ.get('MAIL_USERNAME')\n​    app.config['MAIL_PASSWORD'] = os.environ.get('MAIL_PASSWORD')\n​    app.config['FLASKY_MAIL_SUBJECT_PREFIX'] = '[Flasky]'\n​    app.config['FLASKY_MAIL_SENDER'] = os.environ.get('FLASKY_MAIL_SENDER')\n​    app.config['FLASKY_ADMIN'] = os.environ.get('FLASKY_ADMIN')")]),a._v(" "),s("ul",[s("li",[s("code",[a._v("MAIL_USERNAME")]),a._v("：新浪邮箱的账号")]),a._v(" "),s("li",[s("code",[a._v("MAIL_PASSWORD")]),a._v("：不是新浪邮箱的密码，而是启用POP3/SMTP服务的授权码")]),a._v(" "),s("li",[s("code",[a._v("FLASKY_MAIL_SENDER")]),a._v("：类似这样"),s("code",[a._v("Flasky Admin <xxxxxxx@sina.com>")]),a._v("，填入新浪的邮箱")]),a._v(" "),s("li",[s("code",[a._v("FLASKY_ADMIN")]),a._v("：用于接收邮件的管理员邮箱，可以填自己的其他的163、qq邮箱等")])]),a._v(" "),s("p",[a._v("为了个人的账号密码信息等不泄露，已将敏感信息写入环境变量中，相关操作参考：https://guangmujun.cn/archives/424\n"),s("strong",[a._v("初始化：")]),a._v(" hello.py")]),a._v(" "),s("p",[a._v("​"),s("br"),a._v("\n​    from flask_mail import Mail, Message\n​"),s("br"),a._v("\nmail = Mail(app)")]),a._v(" "),s("h2",{attrs:{id:"_6-3-在程序中集成发送电子邮件功能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-在程序中集成发送电子邮件功能"}},[a._v("#")]),a._v(" 6.3 在程序中集成发送电子邮件功能")]),a._v(" "),s("p",[s("strong",[a._v("案例：")]),a._v(" 每当表单接收一个新名字时，程序发送一封邮件给管理员 hello.py")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[a._v(" def send_email(to, subject, template, **kwargs):\n        \"\"\"\n        用于程序发送邮件\n        :param to: 收件人\n        :param subject: 主题\n        :param template: 邮件模板\n        :param kwargs: 可选参数\n        :return: 程序向收件人发送一封邮件\n        \"\"\"\n        msg = Message(app.config['FLASKY_MAIL_SUBJECT_PREFIX'] + subject,\n                      sender=app.config['FLASKY_MAIL_SENDER'], recipients=[to])\n        msg.body = render_template(template + '.txt', **kwargs)\n        msg.html = render_template(template + '.html', **kwargs)\n        mail.send(msg)\n\n@app.route('/', methods=['GET', 'POST'])\ndef index():\n    form = NameForm()\n    if form.validate_on_submit():\n\n        user = User.query.filter_by(username=form.name.data).first()\n        if user is None:\n            user = User(username=form.name.data)\n            db.session.add(user)\n            session['known'] = False\n            if app.config['FLASKY_ADMIN']:                                                      # 发送邮件\n                send_email(app.config['FLASKY_ADMIN'], 'New User', 'mail/new_user', user=user)  # 使用mail文件夹下的new_user模板\n        else:\n            session['known'] = True\n\n        old_name = session.get('name')\n        if old_name is not None and old_name != form.name.data:\n            flash(\"姓名已修改！\")\n        session['name'] = form.name.data\n        form.name.data = ''\n        return redirect(url_for('index'))\n    return render_template('index.html', form=form, name=session.get('name'),known=session.get('known', False),\n                           current_time=datetime.utcnow())\n")])])]),s("p",[a._v("new_user.html")]),a._v(" "),s("div",{staticClass:"language-html line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[a._v("    \n​    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("meta")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("charset")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')]),a._v("utf-8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n​    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("p")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("Dear {{ user.username }},"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("p")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n\n\n\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br")])]),s("p",[a._v("new_user.txt")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[a._v("Dear "+a._s(a.user.username)+",\n")])])]),s("h2",{attrs:{id:"_6-4-案例运行效果"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-案例运行效果"}},[a._v("#")]),a._v(" 6.4 案例运行效果")]),a._v(" "),s("p",[a._v("在PyCharm中设置好程序需要的环境变量 "),s("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210315101059.png",alt:""}}),a._v(" 运行程序，在表单中输入“番茄”后，效果如下：\n"),s("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210315101138.png",alt:""}}),a._v("\n此时查看我们的管理员邮箱，即"),s("code",[a._v("FLASKY_ADMIN")]),a._v("对应的邮箱，效果如下： "),s("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210315101242.png",alt:""}}),a._v(" "),s("img",{attrs:{src:"https://my-imags.oss-cn-shanghai.aliyuncs.com/pic/20210315101306.png",alt:""}})]),a._v(" "),s("h2",{attrs:{id:"_6-5-异步发送电子邮件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-5-异步发送电子邮件"}},[a._v("#")]),a._v(" 6.5 异步发送电子邮件")]),a._v(" "),s("p",[s("strong",[a._v("原因：")]),a._v(" 当我们在表单中输入新的名字并提交后，发现有几秒钟，浏览器就像无响应的状态一样 为了避免不必要的延迟，将发送电子邮件的函数移动到后台线程中，\n即提交表单后，浏览器页面正常跳转，后台线程进行发送邮件的操作 hello.py")]),a._v(" "),s("p",[a._v("​"),s("br"),a._v("\n​    from threading import Thread")]),a._v(" "),s("p",[a._v("​"),s("br"),a._v("\n​    def send_async_email(app, msg):\n​        with app.app_context():\n​            mail.send(msg)")]),a._v(" "),s("p",[a._v("​"),s("br"),a._v("\n​    def send_email(to, subject, template, **kwargs):\n​        \"\"\"\n​        用于程序发送邮件\n​        :param to: 收件人\n​        :param subject: 主题\n​        :param template: 邮件模板\n​        :param kwargs: 可选参数\n​        :return: 程序向收件人发送一封邮件\n​        \"\"\"\n​        msg = Message(app.config['FLASKY_MAIL_SUBJECT_PREFIX'] + subject,\n​                      sender=app.config['FLASKY_MAIL_SENDER'], recipients=[to])\n​        msg.body = render_template(template + '.txt', **kwargs)\n​        msg.html = render_template(template + '.html', **kwargs)\n​        thr = Thread(target=send_async_email, args=[app, msg])\n​        thr.start()\n​        return thr")])])}),[],!1,null,null,null);n.default=e.exports}}]);